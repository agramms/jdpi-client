# Ruby 3.0 container for matrix testing
FROM ruby:3.0-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    libsqlite3-dev \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set up Ruby environment
ENV BUNDLE_PATH=/usr/local/bundle \
    BUNDLE_BIN=/usr/local/bundle/bin \
    GEM_HOME=/usr/local/bundle \
    PATH=/usr/local/bundle/bin:$PATH

# Install bundler compatible with Ruby 3.0
RUN gem update --system 3.4.22 \
    && gem install bundler -v '~> 2.4'

# Create workspace directory
WORKDIR /workspace

# Set up test environment variables
ENV RAILS_ENV=test \
    RUBY_ENV=test \
    COVERAGE=true

# Default command for testing
CMD ["bundle", "exec", "rake", "test"]